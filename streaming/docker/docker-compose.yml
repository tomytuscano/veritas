##
## Veritas local development stack — Kafka + Spark
##
## Usage:
##   cd streaming/docker
##   docker compose up -d
##
## This brings up a single-node Kafka (KRaft mode, no ZooKeeper) and a
## Spark master/worker pair.  Zeek topics are auto-created on first produce.
##

services:
  # ── Kafka (KRaft, single-node) ──────────────────────────────────────────
  kafka:
    image: bitnami/kafka:3.7
    ports:
      - "9092:9092"
      - "9094:9094"
    environment:
      # KRaft settings (no ZooKeeper).
      KAFKA_CFG_NODE_ID: "1"
      KAFKA_CFG_PROCESS_ROLES: "broker,controller"
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: "1@kafka:9093"
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: "CONTROLLER"

      # Listeners.
      KAFKA_CFG_LISTENERS: "PLAINTEXT://:9092,CONTROLLER://:9093,EXTERNAL://:9094"
      KAFKA_CFG_ADVERTISED_LISTENERS: "PLAINTEXT://kafka:9092,EXTERNAL://localhost:9094"
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: "CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT"
      KAFKA_CFG_INTER_BROKER_LISTENER_NAME: "PLAINTEXT"

      # Topic defaults.
      KAFKA_CFG_NUM_PARTITIONS: "12"
      KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_CFG_LOG_RETENTION_HOURS: "24"

      # Cluster ID (static for reproducibility).
      KAFKA_KRAFT_CLUSTER_ID: "veritas-dev-cluster-001"
    volumes:
      - kafka_data:/bitnami/kafka
    healthcheck:
      test: ["CMD-SHELL", "kafka-broker-api-versions.sh --bootstrap-server localhost:9092"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ── Spark Master ────────────────────────────────────────────────────────
  spark-master:
    image: bitnami/spark:3.5
    ports:
      - "8080:8080"   # Web UI
      - "7077:7077"   # Master port
    environment:
      SPARK_MODE: "master"
      SPARK_MASTER_HOST: "spark-master"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ── Spark Worker ────────────────────────────────────────────────────────
  spark-worker:
    image: bitnami/spark:3.5
    depends_on:
      spark-master:
        condition: service_healthy
    environment:
      SPARK_MODE: "worker"
      SPARK_MASTER_URL: "spark://spark-master:7077"
      SPARK_WORKER_MEMORY: "4g"
      SPARK_WORKER_CORES: "4"

  # ── Kafka UI (optional, for debugging) ──────────────────────────────────
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    ports:
      - "8081:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: "veritas-dev"
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: "kafka:9092"
    depends_on:
      kafka:
        condition: service_healthy

volumes:
  kafka_data:
